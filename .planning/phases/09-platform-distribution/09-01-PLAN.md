---
phase: 09-platform-distribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - /home/flight/develop/homebrew-tap/Formula/markshift.rb
autonomous: false
user_setup:
  - service: npm
    why: "Publishing package to npm registry"
    account_required: true
    actions:
      - task: "Authenticate with npm (if not already)"
        command: "npm login"

must_haves:
  truths:
    - "Package is ready for npm publish with all required metadata"
    - "Homebrew formula exists in user's tap"
    - "User can install via brew install noahkiss/tap/markshift"
    - "Installed CLI runs correctly"
  artifacts:
    - path: "package.json"
      provides: "npm publish metadata (repository, files, engines)"
      contains: "repository"
    - path: "/home/flight/develop/homebrew-tap/Formula/markshift.rb"
      provides: "Homebrew formula for npm-based installation"
      contains: "class Markshift < Formula"
  key_links:
    - from: "Formula/markshift.rb"
      to: "npm registry tarball"
      via: "url field pointing to registry.npmjs.org"
      pattern: "registry.npmjs.org/markshift"
    - from: "Formula/markshift.rb"
      to: "node formula"
      via: "depends_on"
      pattern: 'depends_on "node"'
---

<objective>
Prepare markshift for distribution via Homebrew by completing package.json metadata and creating a formula in the user's custom tap.

Purpose: Enable easy installation of markshift via `brew install noahkiss/tap/markshift` on macOS and Linux
Output: Updated package.json ready for npm publish, Homebrew formula in ~/develop/homebrew-tap/Formula/
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-platform-distribution/09-RESEARCH.md
@package.json
@/home/flight/develop/homebrew-tap/CLAUDE.md
@/home/flight/develop/homebrew-tap/Formula/notify-mcp.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prepare package.json for npm publish</name>
  <files>package.json</files>
  <action>
Update package.json with fields required for npm publish:

1. Add `repository` field:
   ```json
   "repository": {
     "type": "git",
     "url": "git+https://github.com/noahkiss/markshift.git"
   }
   ```

2. Add `files` array to include only dist and necessary files:
   ```json
   "files": [
     "dist",
     "README.md"
   ]
   ```

3. Add `engines` to specify Node.js version requirement:
   ```json
   "engines": {
     "node": ">=20.0.0"
   }
   ```

4. Add `bugs` and `homepage`:
   ```json
   "bugs": {
     "url": "https://github.com/noahkiss/markshift/issues"
   },
   "homepage": "https://github.com/noahkiss/markshift#readme"
   ```

Keep all existing fields. The package is already configured correctly with:
- `"bin": { "markshift": "./dist/cli/index.js" }` (CLI entry point)
- `"type": "module"` (ESM)
- `"main": "dist/index.js"` (library entry)

The shebang is already present in src/cli/index.ts and will be preserved in dist/cli/index.js after build.
  </action>
  <verify>
Run `npm pack --dry-run` to verify package contents are correct:
- Should list dist/ files
- Should NOT include src/, tests/, node_modules/
- Should include README.md
  </verify>
  <done>
package.json has repository, files, engines, bugs, and homepage fields; npm pack --dry-run shows correct file list
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Homebrew formula</name>
  <files>/home/flight/develop/homebrew-tap/Formula/markshift.rb</files>
  <action>
Create the Homebrew formula at `/home/flight/develop/homebrew-tap/Formula/markshift.rb`:

```ruby
class Markshift < Formula
  desc "Suite of tools for converting text to and from Markdown format"
  homepage "https://github.com/noahkiss/markshift"
  url "https://registry.npmjs.org/markshift/-/markshift-0.0.1.tgz"
  sha256 "PLACEHOLDER_SHA256"
  license "MIT"
  head "https://github.com/noahkiss/markshift.git", branch: "main"

  depends_on "node"

  def install
    system "npm", "install", *std_npm_args
    bin.install_symlink libexec.glob("bin/*")
  end

  def caveats
    <<~EOS
      Clipboard support on Linux requires X11.

      For Debian/Ubuntu:
        sudo apt install xorg-dev libxcb-composite0-dev

      For Fedora:
        sudo dnf install libX11-devel libxcb-devel

      Wayland users should enable XWayland for clipboard functionality.
    EOS
  end

  test do
    # Test CLI runs
    assert_match version.to_s, shell_output("#{bin}/markshift --version")

    # Test basic markdown to HTML conversion
    output = shell_output("echo '**bold**' | #{bin}/markshift md-to-html")
    assert_match "<strong>bold</strong>", output

    # Test HTML to markdown conversion
    output = shell_output("echo '<p>hello</p>' | #{bin}/markshift html-to-md")
    assert_match "hello", output
  end
end
```

Key formula elements:
- Uses npm registry tarball (not GitHub tarball) - smaller, pre-transpiled
- Depends on `node` formula (Homebrew's Node.js)
- Uses `std_npm_args` helper for proper npm cache handling
- Symlinks bin from libexec (Homebrew convention for npm packages)
- Caveats document Linux X11 requirement
- Tests verify CLI runs and basic conversions work

The sha256 is a placeholder - it will be updated after npm publish.
  </action>
  <verify>
Run `brew style /home/flight/develop/homebrew-tap/Formula/markshift.rb` to check formula syntax (requires Homebrew installed).
If brew not available, verify file exists and has correct Ruby syntax.
  </verify>
  <done>
Formula file exists at ~/develop/homebrew-tap/Formula/markshift.rb with correct structure, depends_on node, uses std_npm_args
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify installation workflow</name>
  <what-built>
Package.json metadata for npm publish and Homebrew formula for distribution.
  </what-built>
  <how-to-verify>
1. **Verify package.json is ready:**
   ```bash
   cd ~/develop/markshift
   npm pack --dry-run
   ```
   Should show dist/, README.md, package.json only.

2. **To complete distribution (when ready to publish):**

   a. Build the package:
   ```bash
   npm run build
   ```

   b. Publish to npm:
   ```bash
   npm publish
   ```

   c. Get the SHA256 for the formula:
   ```bash
   curl -sL https://registry.npmjs.org/markshift/-/markshift-0.0.1.tgz | sha256sum
   ```

   d. Update the formula sha256 in:
   ```
   ~/develop/homebrew-tap/Formula/markshift.rb
   ```

   e. Commit the formula:
   ```bash
   cd ~/develop/homebrew-tap
   git add Formula/markshift.rb
   git commit -m "Add markshift formula"
   git push
   ```

   f. Test installation:
   ```bash
   brew install noahkiss/tap/markshift
   markshift --version
   echo '**test**' | markshift md-to-html
   ```

3. **Current state verification:**
   - package.json has repository, files, engines fields
   - Formula file exists and passes `brew style` check
   - Formula has placeholder sha256 (will be updated after npm publish)
  </how-to-verify>
  <resume-signal>Type "approved" if package.json and formula are ready, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. package.json contains all npm publish metadata (repository, files, engines, bugs, homepage)
2. `npm pack --dry-run` shows correct file list (dist/, README.md, no src/)
3. Formula exists at ~/develop/homebrew-tap/Formula/markshift.rb
4. Formula syntax is valid (brew style passes or Ruby parses correctly)
5. Formula depends on node and uses std_npm_args pattern
</verification>

<success_criteria>
1. package.json ready for npm publish with complete metadata
2. Homebrew formula created following Node.js formula conventions
3. Formula includes Linux X11 caveats for clipboard support
4. Formula tests verify CLI and basic conversions
5. Clear documentation of publish workflow for user
</success_criteria>

<output>
After completion, create `.planning/phases/09-platform-distribution/09-01-SUMMARY.md`
</output>
