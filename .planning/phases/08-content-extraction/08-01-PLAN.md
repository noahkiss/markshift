---
phase: 08-content-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/converters/html-to-markdown/extractors/content.ts
  - src/converters/html-to-markdown/rules/semantic-table.ts
  - src/converters/html-to-markdown/index.ts
  - src/cli/commands/convert.ts
  - src/cli/types.ts
  - tests/converters/html-to-markdown/content-extraction.test.ts
  - tests/converters/html-to-markdown/semantic-table.test.ts
autonomous: true

must_haves:
  truths:
    - "User can use --extract-content flag to get main article content"
    - "Navigation, ads, and boilerplate are stripped from output"
    - "Div-based tables with role=table are converted to Markdown tables"
    - "Content extraction only applies to HTML input"
  artifacts:
    - path: "src/converters/html-to-markdown/extractors/content.ts"
      provides: "Readability wrapper for content extraction"
      exports: ["extractContent", "ExtractedContent"]
    - path: "src/converters/html-to-markdown/rules/semantic-table.ts"
      provides: "Turndown rule for div-based ARIA tables"
      exports: ["addSemanticTableRule"]
    - path: "src/cli/commands/convert.ts"
      provides: "--extract-content flag integration"
      contains: "extractContent"
    - path: "tests/converters/html-to-markdown/content-extraction.test.ts"
      provides: "Content extraction test coverage"
      min_lines: 50
  key_links:
    - from: "src/cli/commands/convert.ts"
      to: "src/converters/html-to-markdown/extractors/content.ts"
      via: "import and conditional call"
      pattern: "extractContent.*options\\.extractContent"
    - from: "src/converters/html-to-markdown/index.ts"
      to: "src/converters/html-to-markdown/rules/semantic-table.ts"
      via: "addSemanticTableRule(turndown)"
      pattern: "addSemanticTableRule"
---

<objective>
Add content extraction capability to strip navigation, ads, and boilerplate from web pages, plus semantic table detection for div-based ARIA tables.

Purpose: Enable users to get clean article content from web pages without manually removing boilerplate, and properly convert accessible div-based tables to Markdown format.
Output: Content extraction module, semantic table turndown rule, CLI flag integration, comprehensive tests.
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-content-extraction/08-RESEARCH.md

# Existing patterns to follow
@src/converters/html-to-markdown/index.ts
@src/converters/html-to-markdown/rules/code-language.ts
@src/cli/commands/convert.ts
@src/cli/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create content extractor</name>
  <files>
    package.json
    src/converters/html-to-markdown/extractors/content.ts
    tests/converters/html-to-markdown/content-extraction.test.ts
  </files>
  <action>
1. Install @mozilla/readability and linkedom:
   ```bash
   npm install @mozilla/readability linkedom
   ```

2. Create `src/converters/html-to-markdown/extractors/content.ts`:
   - Import { Readability, isProbablyReaderable } from '@mozilla/readability'
   - Import { parseHTML } from 'linkedom'
   - Define ExtractedContent interface with: title, content (HTML string), textContent, excerpt, byline, siteName, publishedTime (all optional except title/content)
   - Export extractContent(html: string): ExtractedContent | null function:
     - Parse HTML with linkedom's parseHTML
     - Check isProbablyReaderable(document) - if false, return null
     - Create new Readability(document, { charThreshold: 500, keepClasses: false })
     - Call reader.parse() and return mapped result or null

3. Create `tests/converters/html-to-markdown/content-extraction.test.ts`:
   - Test: extracts main content from article HTML (create sample with nav, article, footer)
   - Test: returns null for non-article content (minimal HTML without article structure)
   - Test: strips navigation elements
   - Test: strips footer elements
   - Test: preserves article title
   - Test: preserves article text content
   - Test: handles malformed HTML gracefully (no crash)

Note: linkedom types are built-in. @mozilla/readability has built-in TypeScript types since v0.5.0.
  </action>
  <verify>
npm test -- tests/converters/html-to-markdown/content-extraction.test.ts
  </verify>
  <done>Content extraction module exists with tests passing, dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Create semantic table turndown rule and integrate into converter</name>
  <files>
    src/converters/html-to-markdown/rules/semantic-table.ts
    src/converters/html-to-markdown/index.ts
    tests/converters/html-to-markdown/semantic-table.test.ts
  </files>
  <action>
1. Create `src/converters/html-to-markdown/rules/semantic-table.ts`:
   - Import TurndownService type
   - Define DomNode interface (like code-language.ts pattern):
     ```typescript
     interface DomNode {
       nodeName: string;
       getAttribute(name: string): string | null;
       querySelectorAll(selector: string): DomNode[];
       textContent: string | null;
       children: DomNode[];
     }
     ```
   - Export addSemanticTableRule(turndown: TurndownService): void
   - Filter function: return true if node is DIV with:
     - role="table" attribute, OR
     - data-table attribute, OR
     - style attribute containing "display:" and "table"
   - Replacement function:
     - Query for rows: [role="row"], [data-row]
     - If fewer than 2 rows, return original content (not a valid table)
     - For each row, query cells: [role="cell"], [role="columnheader"], [data-cell]
     - Build markdown table:
       - First row as header: | cell1 | cell2 |
       - Separator: | --- | --- |
       - Remaining rows: | cell1 | cell2 |
     - Return table with surrounding newlines

2. Update `src/converters/html-to-markdown/index.ts`:
   - Import { addSemanticTableRule } from './rules/semantic-table.js'
   - In constructor, after addCodeLanguageRule(this.turndown), call:
     addSemanticTableRule(this.turndown)

3. Create `tests/converters/html-to-markdown/semantic-table.test.ts`:
   - Test: converts role="table" div to markdown table
   - Test: converts role="row" and role="cell" structure
   - Test: handles role="columnheader" for header cells
   - Test: ignores divs without table role (no false positives)
   - Test: ignores single-row structures (minimum 2 rows required)
   - Test: preserves cell text content
   - Test: handles data-table/data-row/data-cell attributes
  </action>
  <verify>
npm test -- tests/converters/html-to-markdown/semantic-table.test.ts && npm test
  </verify>
  <done>Semantic table rule converts ARIA tables to Markdown, all tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Add --extract-content flag to CLI convert command</name>
  <files>
    src/cli/types.ts
    src/cli/commands/convert.ts
  </files>
  <action>
1. Update `src/cli/types.ts`:
   - Add to GlobalOptions interface:
     ```typescript
     /** Extract main content from HTML, stripping nav/ads/boilerplate */
     extractContent?: boolean;
     ```

2. Update `src/cli/commands/convert.ts`:
   - Add import: import { extractContent } from '../../converters/html-to-markdown/extractors/content.js'
   - Add option to convertCommand (after existing options):
     .option('--extract-content', 'extract main content from HTML (strip nav/ads/boilerplate)')
   - In action handler, BEFORE conversion but AFTER format detection:
     ```typescript
     // Extract content if requested (HTML only)
     let contentToConvert = content;
     if (globalOpts.extractContent && sourceFormat === 'html') {
       logger.verbose('Extracting main content...');
       const extracted = extractContent(content);
       if (extracted) {
         contentToConvert = extracted.content;
         logger.verbose(`Extracted: "${extracted.title}" (${extracted.content.length} chars)`);
       } else {
         logger.verbose('Content extraction returned null, using original HTML');
       }
     } else if (globalOpts.extractContent && sourceFormat !== 'html') {
       logger.verbose('--extract-content ignored: source is not HTML');
     }
     ```
   - Update all converter calls to use contentToConvert instead of content
   - For RTF pipeline: apply extraction to htmlResult.content (intermediate HTML)

3. Verify with manual test:
   ```bash
   echo '<html><nav>Menu</nav><article><h1>Title</h1><p>Content</p></article><footer>Footer</footer></html>' | npm run cli -- convert --extract-content
   ```
   Should output markdown without nav/footer elements.
  </action>
  <verify>
npm run cli -- convert --help | grep -q "extract-content" && echo "Flag documented" && npm test
  </verify>
  <done>--extract-content flag works for HTML input, extracts article content, all tests pass</done>
</task>

</tasks>

<verification>
1. All existing tests pass: `npm test`
2. Content extraction works:
   ```bash
   echo '<html><nav>Menu</nav><article><h1>Title</h1><p>Article text here.</p></article></html>' | npm run cli -- convert --extract-content
   ```
3. Semantic tables convert:
   ```bash
   echo '<div role="table"><div role="row"><div role="columnheader">A</div><div role="columnheader">B</div></div><div role="row"><div role="cell">1</div><div role="cell">2</div></div></div>' | npm run cli -- convert
   ```
4. Flag is ignored for non-HTML: `echo '# Markdown' | npm run cli -- convert --extract-content -t html` (no error)
5. Verbose output shows extraction: `echo '<article>...</article>' | npm run cli -- convert --extract-content --verbose 2>&1 | grep -i extract`
</verification>

<success_criteria>
1. `npm test` passes with new content extraction and semantic table tests
2. `markshift convert --extract-content` extracts main article content from HTML
3. Navigation, footer, sidebar elements are stripped by extraction
4. Div-based tables with role="table" convert to Markdown table syntax
5. --extract-content flag is documented in --help output
6. Extraction gracefully handles non-article content (returns original)
7. Flag is ignored with verbose message for non-HTML input
</success_criteria>

<output>
After completion, create `.planning/phases/08-content-extraction/08-01-SUMMARY.md`
</output>
