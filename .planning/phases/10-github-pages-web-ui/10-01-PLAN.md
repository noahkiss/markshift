---
phase: 10-github-pages-web-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.ts
  - src/web/browser-converters.ts
  - src/web/empty-module.ts
autonomous: true

must_haves:
  truths:
    - "Vite builds browser bundle without Node-only dependencies"
    - "Browser converters use native DOMParser instead of linkedom"
    - "Content extraction works with DOMPurify sanitization"
  artifacts:
    - path: "vite.config.ts"
      provides: "Vite configuration for GitHub Pages"
      contains: "base: '/markshift/'"
    - path: "src/web/browser-converters.ts"
      provides: "Browser-safe converter wrappers"
      exports: ["htmlToMarkdown", "markdownToHtml", "extractContent"]
    - path: "src/web/empty-module.ts"
      provides: "Empty module for linkedom alias"
  key_links:
    - from: "vite.config.ts"
      to: "src/web/empty-module.ts"
      via: "resolve.alias for linkedom"
      pattern: "linkedom.*empty-module"
    - from: "src/web/browser-converters.ts"
      to: "DOMParser"
      via: "native browser DOM API"
      pattern: "new DOMParser"
---

<objective>
Set up Vite build tooling and create browser-specific converter wrappers for the web UI.

Purpose: Establish the build infrastructure and browser-safe converters that the web UI will use. This separates Node-only code (linkedom) from browser code (native DOMParser).

Output: Vite config, browser converter module, empty module alias for linkedom
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-github-pages-web-ui/10-RESEARCH.md

# Existing converters to wrap
@src/converters/html-to-markdown/index.ts
@src/converters/markdown-to-html/index.ts
@src/converters/html-to-markdown/extractors/content.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vite and DOMPurify dependencies</name>
  <files>package.json</files>
  <action>
Install the required dependencies:

```bash
npm install -D vite @types/dompurify
npm install dompurify
```

Add build script to package.json scripts:
- `"build:web": "vite build"`
- `"dev:web": "vite"` (for local development)

Do NOT modify existing scripts. These are additive.
  </action>
  <verify>
`npm ls vite` shows vite installed as devDependency
`npm ls dompurify` shows dompurify installed as dependency
`grep "build:web" package.json` shows the script exists
  </verify>
  <done>Vite and DOMPurify installed, build:web script added to package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create Vite configuration and empty module alias</name>
  <files>vite.config.ts, src/web/empty-module.ts</files>
  <action>
Create `vite.config.ts` in project root with:
- `root: 'src/web'` - source files in src/web/
- `base: '/markshift/'` - GitHub Pages subpath for noahkiss.github.io/markshift
- `build.outDir: '../../docs'` - output to docs/ for GitHub Pages
- `build.emptyOutDir: true` - clean output directory
- `build.target: 'es2020'` - modern browser target
- `resolve.alias` mapping `linkedom` to `./src/web/empty-module.ts` to exclude Node-only dependency

Create `src/web/empty-module.ts`:
```typescript
// Empty module to replace linkedom in browser builds
// linkedom is Node-only; browser uses native DOMParser
export const parseHTML = (): never => {
  throw new Error('parseHTML is not available in browser. Use DOMParser.');
};
export default {};
```

Note: Use `path.resolve(__dirname, ...)` for the alias path in vite.config.ts.
  </action>
  <verify>
`cat vite.config.ts` shows the configuration
`cat src/web/empty-module.ts` shows the empty module
`npx vite build --config vite.config.ts 2>&1 | head -5` runs without immediate error (will fail on missing entry, that's expected)
  </verify>
  <done>Vite configured with GitHub Pages base path, linkedom aliased to empty module</done>
</task>

<task type="auto">
  <name>Task 3: Create browser-specific converter wrappers</name>
  <files>src/web/browser-converters.ts</files>
  <action>
Create `src/web/browser-converters.ts` that wraps the existing converters for browser use:

1. Import and re-export HtmlToMarkdownConverter and MarkdownToHtmlConverter from existing modules
2. Create browser-native `extractContent` function that:
   - Uses native `DOMParser` to parse HTML (NOT linkedom)
   - Clones document before passing to Readability (prevents DOM mutation)
   - Sanitizes output with DOMPurify
   - Returns ExtractedContent | null matching the Node version's interface

```typescript
import { HtmlToMarkdownConverter } from '../converters/html-to-markdown/index.js';
import { MarkdownToHtmlConverter } from '../converters/markdown-to-html/index.js';
import { Readability } from '@mozilla/readability';
import DOMPurify from 'dompurify';

// Re-export converter instances
export const htmlToMarkdownConverter = new HtmlToMarkdownConverter();
export const markdownToHtmlConverter = new MarkdownToHtmlConverter();

// Convenience functions
export function htmlToMarkdown(html: string): string {
  return htmlToMarkdownConverter.convert(html).content;
}

export function markdownToHtml(markdown: string): string {
  return markdownToHtmlConverter.convert(markdown).content;
}

// Browser-native content extraction interface
export interface ExtractedContent {
  title: string;
  content: string;
  textContent?: string;
  excerpt?: string;
  byline?: string;
  siteName?: string;
  publishedTime?: string;
}

const MIN_CONTENT_LENGTH = 100;

// Browser-native content extraction (replaces linkedom-based version)
export function extractContent(html: string): ExtractedContent | null {
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    // IMPORTANT: Clone to prevent Readability from modifying original
    const docClone = doc.cloneNode(true) as Document;

    const reader = new Readability(docClone, {
      charThreshold: 500,
      keepClasses: false,
    });

    const result = reader.parse();

    if (!result || !result.content || result.content.length < MIN_CONTENT_LENGTH) {
      return null;
    }

    return {
      title: result.title || '',
      content: DOMPurify.sanitize(result.content),
      textContent: result.textContent || undefined,
      excerpt: result.excerpt || undefined,
      byline: result.byline || undefined,
      siteName: result.siteName || undefined,
      publishedTime: result.publishedTime || undefined,
    };
  } catch {
    return null;
  }
}
```

Keep the same interface as the Node version so the web UI can use identical patterns.
  </action>
  <verify>
`cat src/web/browser-converters.ts` shows the module with all three exports
TypeScript compiles: `npx tsc --noEmit src/web/browser-converters.ts 2>&1 || echo "TS check done"`
  </verify>
  <done>Browser converters created with native DOMParser for content extraction, DOMPurify for sanitization</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm ls vite dompurify` shows both dependencies installed
2. `ls -la vite.config.ts src/web/` shows config and web directory exist
3. `grep -l "DOMParser" src/web/browser-converters.ts` confirms native DOM usage
4. `grep -l "DOMPurify" src/web/browser-converters.ts` confirms sanitization
</verification>

<success_criteria>
- Vite and DOMPurify installed as dependencies
- vite.config.ts configured for GitHub Pages (/markshift/ base path)
- Browser converters module exports htmlToMarkdown, markdownToHtml, extractContent
- Content extraction uses native DOMParser (no linkedom import)
- linkedom aliased to empty module in Vite config
</success_criteria>

<output>
After completion, create `.planning/phases/10-github-pages-web-ui/10-01-SUMMARY.md`
</output>
