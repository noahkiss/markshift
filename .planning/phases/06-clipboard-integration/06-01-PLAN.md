---
phase: 06-clipboard-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/cli/utils/clipboard.ts
  - src/cli/utils/io.ts
  - src/cli/types.ts
  - src/cli/program.ts
  - src/cli/commands/convert.ts
  - src/cli/commands/html-to-md.ts
  - src/cli/commands/md-to-html.ts
  - tests/cli/clipboard.test.ts
autonomous: true

must_haves:
  truths:
    - "User can read content from clipboard using --paste flag"
    - "User can write conversion result to clipboard using --copy flag"
    - "Multiple clipboard formats are read with preference order (HTML > RTF > text)"
    - "Clipboard operations work on macOS"
    - "Clipboard operations work on Linux"
    - "RTF clipboard content is detected but warns user (Phase 7 conversion)"
  artifacts:
    - path: "src/cli/utils/clipboard.ts"
      provides: "Clipboard read/write utilities"
      exports: ["readClipboard", "writeClipboard"]
    - path: "src/cli/types.ts"
      provides: "Updated GlobalOptions with paste/copy"
      contains: "paste?: boolean"
  key_links:
    - from: "src/cli/commands/convert.ts"
      to: "src/cli/utils/clipboard.ts"
      via: "readClipboard when --paste"
      pattern: "readClipboard"
    - from: "src/cli/utils/io.ts"
      to: "src/cli/utils/clipboard.ts"
      via: "imports clipboard functions"
      pattern: "from.*clipboard"
---

<objective>
Add clipboard integration with --paste and --copy flags to all CLI commands

Purpose: Enable seamless workflow integration by reading from and writing to system clipboard, supporting multiple clipboard formats (HTML > RTF > text) with automatic format detection.

Output: Updated CLI with global --paste and --copy flags, clipboard utility module, and tests
</objective>

<execution_context>
@/home/flight/.claude/get-shit-done/workflows/execute-plan.md
@/home/flight/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-clipboard-integration/06-RESEARCH.md

# Existing CLI structure
@src/cli/program.ts
@src/cli/types.ts
@src/cli/utils/io.ts
@src/cli/commands/convert.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @crosscopy/clipboard and create clipboard utilities</name>
  <files>
    package.json
    src/cli/utils/clipboard.ts
    tests/cli/clipboard.test.ts
  </files>
  <action>
1. Install @crosscopy/clipboard:
   ```bash
   npm install @crosscopy/clipboard
   ```

2. Create `src/cli/utils/clipboard.ts` with:
   - `readClipboard()`: Async function that checks formats in preference order (HTML > RTF > text)
     - Use `Clipboard.hasHtml()`, `Clipboard.hasRtf()`, `Clipboard.hasText()` to check availability
     - Return `{ content: string, sourceFormat: 'html' | 'rtf' | 'text' }`
     - For RTF: return the content but also return sourceFormat as 'rtf' (Phase 7 will handle conversion)
     - Throw descriptive error if clipboard empty or only contains images/files
   - `writeClipboard(content: string)`: Async function to write text to clipboard using `Clipboard.setText()`

3. Create `tests/cli/clipboard.test.ts`:
   - Mock @crosscopy/clipboard module (vi.mock)
   - Test readClipboard format preference order (mock hasHtml=true returns html)
   - Test readClipboard returns RTF when only RTF available
   - Test readClipboard returns text as fallback
   - Test readClipboard throws when clipboard empty
   - Test writeClipboard calls setText with content

Import pattern from research:
```typescript
import Clipboard from '@crosscopy/clipboard';
```

Error message for empty clipboard:
"Clipboard is empty or contains only images/files.\nCopy some text, HTML, or RTF content first."
  </action>
  <verify>
    npm test -- tests/cli/clipboard.test.ts passes
    npm run typecheck passes
  </verify>
  <done>
    Clipboard utility module exists with readClipboard and writeClipboard functions
    All clipboard tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --paste and --copy global options to CLI</name>
  <files>
    src/cli/types.ts
    src/cli/program.ts
    src/cli/utils/io.ts
    src/cli/commands/convert.ts
    src/cli/commands/html-to-md.ts
    src/cli/commands/md-to-html.ts
    tests/cli/io.test.ts
  </files>
  <action>
1. Update `src/cli/types.ts`:
   - Add to GlobalOptions interface:
     ```typescript
     /** Read input from system clipboard */
     paste?: boolean;
     /** Write output to system clipboard */
     copy?: boolean;
     ```

2. Update `src/cli/program.ts`:
   - Add after existing global options:
     ```typescript
     .option('--paste', 'read input from system clipboard')
     .option('--copy', 'write output to system clipboard')
     ```

3. Update `src/cli/utils/io.ts`:
   - Import `readClipboard`, `writeClipboard` from './clipboard.js'
   - Modify `readInput(inputPath?: string, options?: { paste?: boolean })`:
     - If `options?.paste && inputPath`: throw error "Cannot use --paste with file input. Choose one."
     - If `options?.paste`: call and return `await readClipboard()` (returns { content, sourceFormat })
     - Otherwise: existing logic (return content only, no sourceFormat)
   - Modify `writeOutput(outputPath, content, options?: { copy?: boolean })`:
     - If `options?.copy && outputPath`: throw error "Cannot use --copy with file output. Choose one."
     - If `options?.copy`: call `await writeClipboard(content)` and return (don't write to stdout)
     - Otherwise: existing logic

4. Update `src/cli/commands/convert.ts`:
   - Get paste/copy from globalOpts
   - Pass { paste: globalOpts.paste } to readInput
   - If readInput returns sourceFormat (from clipboard), use it instead of detectFormat()
   - Pass { copy: globalOpts.copy } to writeOutput
   - For RTF sourceFormat: log warning "RTF detected. RTF-to-Markdown conversion coming in Phase 7. Using plain text for now." and treat as text

5. Update `src/cli/commands/html-to-md.ts`:
   - Get paste/copy from globalOpts
   - Pass { paste: globalOpts.paste } to readInput
   - If sourceFormat is 'rtf': throw error "RTF content detected. Use 'convert' command or wait for Phase 7."
   - Pass { copy: globalOpts.copy } to writeOutput

6. Update `src/cli/commands/md-to-html.ts`:
   - Same pattern as html-to-md

7. Create/update `tests/cli/io.test.ts`:
   - Test mutual exclusivity: --paste with file input throws
   - Test mutual exclusivity: --copy with file output throws
   - Mock clipboard functions for integration
  </action>
  <verify>
    npm test passes (all tests)
    npm run typecheck passes
    Manual test: Copy HTML in browser, run `markshift convert --paste` and see markdown output
    Manual test: Run `echo "# Test" | markshift convert --copy` then paste to see HTML
  </verify>
  <done>
    --paste and --copy global options work on all commands
    Mutual exclusivity enforced (--paste can't combine with file input, --copy can't combine with file output)
    RTF clipboard content shows appropriate warning/error
  </done>
</task>

</tasks>

<verification>
1. `npm test` - All tests pass including new clipboard tests
2. `npm run typecheck` - No TypeScript errors
3. `markshift --help` shows --paste and --copy options
4. Manual test on macOS: Copy formatted text, run `markshift convert --paste`, verify markdown output
5. Manual test: `echo "<h1>Test</h1>" | markshift convert --copy`, paste to verify HTML in clipboard
</verification>

<success_criteria>
- [ ] @crosscopy/clipboard installed and working
- [ ] readClipboard() reads with HTML > RTF > text preference
- [ ] writeClipboard() writes to system clipboard
- [ ] --paste flag reads from clipboard on all commands
- [ ] --copy flag writes to clipboard on all commands
- [ ] Mutual exclusivity enforced (--paste vs file, --copy vs file)
- [ ] RTF detection works with appropriate messaging
- [ ] All tests pass
- [ ] Works on macOS (primary platform)
</success_criteria>

<output>
After completion, create `.planning/phases/06-clipboard-integration/06-01-SUMMARY.md`
</output>
